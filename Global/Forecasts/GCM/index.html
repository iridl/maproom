<INGRID>
SOURCES IRIONLY .IRI 
mimeheader
pop
</INGRID>

<html><head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>GCM Maproom</title>
    <STYLE TYPE="text/css">
    <!--
    P.indented
       {
       padding-left: 25pt;
       padding-right: 25pt;
       text-align: justify;
       }
    -->
    </STYLE>

<script type="text/javascript">
<!--

//-->
</script>

<INGRID>
figdefs
</INGRID>

</head>
<body bgcolor="#FFFFFF"  link="#993333" vlink="#993333" alink="#FF0000" onLoad='initdrag();document.mapform.reset();' onunload="window.setTimeout('resetdrag',5000);">


<INGRID>
leftmenuHeader
</INGRID>

<FORM name=mapform action=index.html>
<center>
<table width=100% align="center">
<tr>
<td><h3 align=center><u>Individual AGCM Predictions</u></h3></td>
</tr>
</table>

<table align=center>
<tr align=center><td>
<table>
<tr><td><table  align=center>

<tr valign=top>
<td align=left bgcolor=#000066>
<b><font point-size=9pt color=#FFFFFF>Variable:</font></b>
<INGRID>
(<select name="Variable" id="Variable" onChange="changedtext(this)">) print
[(Temperature) (Precipitation)] {
  (<option value=) print
  dup print /Variable FORMgetknown {
    1 index eq {( selected=selected) print} if}{
    dup (Temperature) eq {( selected=selected) print} if (Temperature) /Variable FORM!
  }ifelse
  (>) print print (</option>) print
}forall
(</select>)print
</INGRID>

</td>
<td align=left bgcolor=#FFFFCC>
<b><font point-size=9pt>Field:</font></b>
<INGRID>
%PercentOfMedian is for percipitation only
(<select name="Field" id="Field" onChange="changedtext(this)">) print
/Variable FORMgetknown {(Precipitation) eq}{false}ifelse {[(Total) (Anomaly) (PercentOfMedian)]}{[(Total) (Anomaly)]}ifelse {
  (<option value=) print
  dup print /Field FORMgetknown {
    dup (PercentOfMedian) eq {
      /Variable FORMget (Temperature) eq {
        pop dup (Total) eq {( selected=selected) print}if (Total) /Field FORM!
      }{
        1 index eq {( selected=selected) print} if
      }ifelse
    }{
      1 index eq {( selected=selected) print} if
    }ifelse
  }{
    dup (Total) eq {( selected=selected) print} if (Total) /Field FORM!
  }ifelse
  (>) print print (</option>) print
}forall
(</select>)print
</INGRID>
</td>


<td align=left bgcolor=#000066>
<b><font point-size=9pt color=#FFFFFF>Model:</font></b>
<INGRID>
(<select name="Model" id="Model" onChange="document.mapform.submit();">) print
[(ECHAM4p5) (CCM3v6) (NCEP) (NSIPP-1) (COLA) (ECPC) (GFDL)] {
% (ECHAM4p5-MOM3)] {
  (<option value=) print
  dup print /Model FORMgetknown {
    1 index eq {( selected="selected") print} if}{
    dup (ECHAM4p5) eq {( selected="selected") print} if (ECHAM4p5) /Model FORM!
  }ifelse
  (>) print print (</option>) print
}forall
(</select>)print
</INGRID>

</td>

<INGRID>

%Options is where I put definitions I need that depend on the previous choices

/Options null 8 object /myOptions 1 index def /==alias /myOptions def
def

Options
/linkTag
% COLA and GFDL don't have standard directory tree
/Model FORMget dup (COLA) eq {
  ( .T63 )}{
  dup (GFDL) eq {
    ( .AM2p12b )}{
    ()
  }ifelse
}ifelse
exch pop
put

Options
/ensembleTag
% ECHAM4p5 doesn't have standard directory tree
/Model FORMget (ECHAM4p5) eq {
  /Ocean FORMgetknown {}{(ssst) dup /Ocean FORM!}ifelse (psst) eq {
    ( .ensemble24 ) put 
  }{
    ( .ensemble ) put
  }ifelse
}{
  ( .ensemble ) put
}ifelse

%here I can start my stack
/Model FORMget (ECHAM4p5-MOM3) eq {
  SOURCES .IRI .MP .RESEARCH .COUPLED .GLOBAL .ECHAM4p5-MOM3-realtime ATM
}{
  SOURCES .IRI .FD /Model FORMget interp Options /linkTag get interp .Forecast
}ifelse
</INGRID>

<td align=left bgcolor=#FFFFCC>
<b><font point-size=9pt>Forcing:</font></b>

<INGRID>

Options
/isthereSST false put

/Model FORMget (ECHAM4p5-MOM3) eq {
(<font color=#FF0000>This is a COUPLED model</font>)print
}{
%here I get all the kinds of sst forcing for the chose model
[currentobject {
  exec totype /datasettype eq {
    cvntos dup (asst) eq not {dup (ssst) eq not {dup (psst) eq not {pop}if}if}if
  }{
    pop
  }ifelse
}forsomedataset]

%here I must check that what is chosen for /Ocean still exists after I make other changes
%this is because all models don't have all possible sst forcing
dup {
  /Ocean FORMgetknown {
    eq {Options /isthereSST true put}if
  }{
    pop
  }ifelse
}forall

%I choose back ssst if the current choice doesn't exsit for the new chosen model
Options /isthereSST get not { (ssst) /Ocean FORM! }if

%Eventually I can start the loop to create the menu
{
  (<input type=radio name=Ocean onChange="document.mapform.submit();" value=) print
  dup s== print /Ocean FORMgetknown {
    1 index eq {( checked) print Options /isthereSST true put }if
  }{
    (ssst) 1 index eq {( checked) print}if
  }ifelse
  /Model FORMget (ECHAM4p5-MOM3) eq {( disabled="disabled")print}if
(><font point-size=9pt>)print print (</font>\n) print
}forall
(</select>)print
}ifelse
</INGRID>
</td>
</tr>
</table>
</td>
</tr>

<INGRID>

%moving on with the stack
/Model FORMget (ECHAM4p5-MOM3) eq not{
  /Ocean FORMget interp nip Options /ensembleTag get interp .monthly
}if
[M]average

</INGRID>

<tr><td><table>
<tr>
<td align=left bgcolor=#000066>
<b><font point-size=9pt color=#FFFFFF>Forecast issued:</font></b>
<INGRID>

Options /isthereS false put


S
dup CopyStream getrealization {
  /map FORMgetknown {/S getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{
    2 index 2 index cvsunits nip eq {Options /isthereS true put}if pop
  }{
    pop
  }ifelse
}forall

/map FORMgetknown {/S getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{
  Options /isthereS get {
    pop
  }{
    last cvsunits
    (<script type="text/javascript" language="JavaScript">) print
    (setform) print
    lpar print
    (document.mapform,"map.S.plotvalue",') print
    print 
    (') print
    rpar print
    (;) print
    ( document.mapform.submit();)print
    (</script>) print
  }ifelse
}if

(<select name="map.S.plotvalue" onChange='dovaluebutton(this,"map.S.plotvalue")'>) print
dup CopyStream getrealization {
  (<option value=) print
  dup 2 index exch cvsunits (")print print (")print pop /map FORMgetknown {/S getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{
    2 index 2 index cvsunits nip eq {( selected="selected") print} if
  }{
    dup 2 index .last eq {( selected="selected")print}if 
  }ifelse
  (>) print cvsunits 7 8 getinterval print (</option>) print
}forall
(</select>)print
pop
</INGRID>
</td>

<INGRID>
%moving on with the stack
%I need T (forecast time) at various occasions
a:
  .T
:a:
  dup S /map FORMgetknown {/S getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
    1 index .S .last
  }ifelse VALUE 
  dup null eq {
    pop S last VALUE
  }{
  nip
  }ifelse
:a
</INGRID>

<td align=left bgcolor=#000066>
<b><font point-size=9pt color=#FFFFFF>Target Season:</font></b>
<INGRID>
%those models are monthly but I want to show seasonal outputs, that's why there is L 3 runningAverage in various places of the code
T
  L 3 runningAverage
  /pointwidth 3 def
dup .L CopyStream getrealization {
  (<input type=radio name="map.L.plotvalue" onChange='dovaluebutton(this,"map.L.plotvalue")' value=) print
  dup s== print /map FORMgetknown {/L getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse {
    interp 1 index eq {( checked) print }if  
  }{
    1.5 1 index eq {( checked) print}if
  }ifelse
  ( color=#FFFFFF><font color=#FFFFFF>)print 1 index exch L exch VALUE getrealization 0 get cvsunits print (</font>\n) print
}forall
(</select>)print pop
</INGRID>
</td>
</tr>

<INGRID>

% Here I store different tags to set the variable, its units, its colorbar, its range, according to different choices
/Variable FORMget (Temperature) eq {
  Options /varName ( .t2m ) put 
  Options /varUnit ( (Celsius_scale) unitconvert ) put
  Options /varColor /Field FORMget (Total) eq {( temp_colors ) put}if
            /Field FORMget (Anomaly) eq {( temp_anomaly_colors_gcm ) put}if
  Options /varRange /Field FORMget (Total) eq {( ) put}if
            /Field FORMget (Anomaly) eq {( ) put}if
}if

/Variable FORMget (Precipitation) eq {
  Options /varName /Model FORMget (ECHAM4p5-MOM3) eq {
    ( .prec ) put
  }{
    ( .prcp ) put
  }ifelse
  Options /varUnit ( (mm/day) unitconvert ) put
  Options /varColor /Field FORMget (Total) eq {( precip_colors ) put}if
            /Field FORMget (Anomaly) eq {( prcp_anomaly_25max500_colors2_nan ) put}if
            /Field FORMget (PercentOfMedian) eq {( prcp_anomaly_25max500_colors2_percentmedian ) put}if
}if

%keep moving with my stack
/Model FORMget (ECHAM4p5-MOM3) eq{
  .Surface
}if 
Options /varName get interp 
Options /varUnit get interp
  L 3 runningAverage
  /pointwidth 3 def

</INGRID>

<tr>
<td align=right bgcolor=#FFFFCC>
<b><font point-size=9pt>Skill Mask:</font></b>
<INGRID>
%it's none only for now because the observations dataset to define the skill from is not yet defined
(<select name="Skill" id="Skill" onChange="changedtext(this)">) print
[(none)] {
% (-0.9) (-0.8) (-0.7) (-0.6) (-0.5) (-0.4) (-0.3) (-0.2) (-0.1) (0) (0.1) (0.2) (0.3) (0.4) (0.5) (0.6) (0.7) (0.8) (0.9) (1)] {
  (<option value=) print
  dup print /Skill FORMgetknown {
    1 index eq {( selected="selected") print} if}{
    dup (none) eq {( selected="selected") print} if (none) /Skill FORM!
  }ifelse
  (>) print print (</option>) print
}forall
(</select>)print
</INGRID>
</td></tr>

</table></td></tr>

</table>
</td></tr>

</table>
</td></tr>
<tr align=center><td align=center valign=top><table align=center><tr align=center><td>

<INGRID>

% If the FORM is not yet ready, I need to force the correct global map setting
/map FORMgetknown {
  pop
}{
  X -20 180 -20 RANGE
  Y -60 80 RANGE
}ifelse

%here are the options for the analysis (if Mean I don't need to do anything)
/Field FORMget (Anomaly) eq {
  /Model FORMget (ECHAM4p5-MOM3) eq {
    2 index .ATM .Surface
     Options /varName get interp
     Options /varUnit get interp
    [M]average
    S (0000 1 Jan 1982) (0000 1 Dec 2008) RANGE
    S 12 splitstreamgrid
    [S2]average
  }{ 
    S dup CopyStream getrealization
    0 get
    cvsunits
    interp dup 2003 ge {
      pop pop pop pop pop
      2 index /Model FORMget interp nip .History .climatology .c7100
      Options /varName get interp
      Options /varUnit get interp
    }{
      dup 2002 ge {pop pop pop pop pop true}{2001 ge {6.5 ge {pop pop pop true}{pop pop pop false}ifelse}{pop pop pop pop false}ifelse}ifelse {
        /Model FORMget (ECHAM4p5) eq {
          2 index /Model FORMget interp nip .History .ensemble_mean .monthly
          Options /varName get interp
          Options /varUnit get interp
          T (1969) (1999) RANGE
          yearly-climatology
        }{
          2 index /Model FORMget interp nip .History .climatology .c6998
          Options /varName get interp
          Options /varUnit get interp
        }ifelse
      }{
        2 index /Model FORMget interp nip .History .ensemble_mean .monthly
        Options /varName get interp
        Options /varUnit get interp
        T (1961) (1990) RANGE
        yearly-climatology 
      }ifelse
    }ifelse
    2 index
    T sample-along
  }ifelse
    L 3 runningAverage
      /pointwidth 3 def
  sub
}if

/Field FORMget (PercentOfMedian) eq {
  /Model FORMget (ECHAM4p5-MOM3) eq {
    2 index .ATM .Surface
     Options /varName get interp
     Options /varUnit get interp
    [M]average
    S (0000 1 Jan 1982) (0000 1 Dec 2008) RANGE
    S 12 splitstreamgrid
    [S2]medianover
  }{
    S dup CopyStream getrealization
    0 get
    cvsunits
    interp dup 2003 ge {
      pop pop pop pop pop
      2 index /Model FORMget interp nip .History .ensemble_mean .monthly
      Options /varName get interp
      Options /varUnit get interp
      T (1971) (2000) RANGE
      T 12 splitstreamgrid
      [T2]medianover
    }{
      dup 2002 ge {pop pop pop pop pop true}{2001 ge {6.5 ge {pop pop pop true}{pop pop pop false}ifelse}{pop pop pop pop false}ifelse}ifelse {
        2 index /Model FORMget interp nip .History .ensemble_mean .monthly
        Options /varName get interp
        Options /varUnit get interp
        T (1969) (1999) RANGE
        T 12 splitstreamgrid
        [T2]medianover
      }{
        2 index /Model FORMget interp nip .History .ensemble_mean .monthly
        Options /varName get interp
        Options /varUnit get interp
        T (1961) (1990) RANGE
        T 12 splitstreamgrid
        [T2]medianover
      }ifelse
    }ifelse
    2 index
    T sample-along
  }ifelse
    L 3 runningAverage
      /pointwidth 3 def
  div
  (%) unitconvert Infinity maskge
}if

/Variable FORMget (Precipitation) eq {
  /PrcpUnits FORMknown not {(mm/day) /PrcpUnits FORM!}if
  Options /varRange /Field FORMget (Total) eq {
              /PrcpUnits FORMget (mm/day) eq {( ) put}if
              /PrcpUnits FORMget (mm) eq {( DATA 0 2000 RANGE ) put}if
            }if
            /Field FORMget (Anomaly) eq {
              /PrcpUnits FORMget (mm/day) eq {( DATA -10 10 RANGE ) put}if
              /PrcpUnits FORMget (mm) eq {( ) put}if
            }if
            /Field FORMget (PercentOfMedian) eq {( DATA 0 400 RANGE ) put}if
}if

/Field FORMget (PercentOfMedian) eq not {
/PrcpUnits FORMgetknown {
  (mm) eq {
    a:
    L (days since 1960-01-01) streamgridunitconvert
    L differential_mul
    L :a: .L :a
    replaceGRID
  }if
}{
  (mm/day) /PrcpUnits FORM!
}ifelse
}if

  L /map FORMgetknown {/L getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
    1.5
  }ifelse VALUE

/Skill FORMget dup (none) eq {
  pop
}{
  SOURCES .IRI .FD /Model FORMget interp nip .History
    a: .ensemble_mean .monthly Options /varName get interp
   :a: .climatology .c7100  Options /varName get interp :a
    sub
    T 4 index
      L 3 runningAverage
        /pointwidth 3 def
      L /map FORMgetknown {/L getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
        1.5
      }ifelse VALUE
    dup getrealization 0 get cvsunits 0 7 getinterval nip
    seasonalAverage
    T (1971-2000) VALUES
  SOURCES .UEA .CRU .TS2p1
    a: .monthly /Variable FORMget (Precipitation) eq {
      Options /varName get interp
    }{
      .mean .temp
    }ifelse
   :a: .climatology .c7100  /Variable FORMget (Precipitation) eq {
      Options /varName get interp
    }{
      .mean .temp
    }ifelse :a
    sub
    T 5 index 
      L 3 runningAverage
        /pointwidth 3 def
      L /map FORMgetknown {/L getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
        1.5
      }ifelse VALUE
    dup getrealization 0 get cvsunits 0 7 getinterval nip
    seasonalAverage
    T (1971-2000) VALUES
  1 index gridtomatch
  [T]correlate
  exch interp flagge 0 maskle
  mul
}ifelse

Options /varColor get interp
Options /varRange get interp

/Field FORMget (PercentOfMedian) eq {
  DATA 10 25 50 75 90 100 120 150 200 250 300 400 VALUES
}if

exch
L 3 runningAverage
/pointwidth 3 def
S /map FORMgetknown {/S getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
  1 index .S .last
}ifelse VALUE
L /map FORMgetknown {/L getknown {/plotvalue getknown {true}{false}ifelse}{false}ifelse}{false}ifelse{}{
  1.5
}ifelse VALUE

1 index [X Y]average getrealization 0 get NaN eq {
(<tr><td><font color=#FF0000 point-size=18pt><b><BLINK>DATA NOT AVAILABLE</BLINK></b></font></td></tr></div>)print
}if

X Y fig- colors thinnish grey coasts lakes | black nozero contours plotlabel -fig
/plotaxislength 590 psdef
/antialias true psdef
/framelabel [(%=[T] IRI seasonal Forecast Temperature issued %=[S] from ) /Model FORMget ]concat psdef

figdup

/map
inputimagelinkwithlimitcontrolsclickforinfo

</INGRID>
<br>
<INGRID>
figdup .auxfig
imagelink

( </td></tr></table></td></tr>
<tr><td align=center valign=top> )print

%Defining a button to switch precip units
/Variable FORMget (Precipitation) eq {/Field FORMget (PercentOfMedian) ne}{false}ifelse {
  [(mm/day) (mm)] {
    (<input type=radio name=PrcpUnits onChange="document.mapform.submit();" value=) print
    dup print /PrcpUnits FORMgetknown {
      1 index eq {( checked)print}if}{
      dup (mm/day) eq {( checked)print}if (mm/day) /PrcpUnits FORM!
    }ifelse
    (>)print print (\n) print
  }forall
  (</select>)print
}if

( </table>

)print

</INGRID>

<p>
<table>
<table align=center>
<table BORDER COLS=1 WIDTH=650 bgcolor="#F5F5F5" NOSAVE align=center>
<tr><td align=center bgcolor=#DCDCDC><b>Map Description</b></td></tr>
<tr><td align=justify><font size=-1>
The map displays mean seasonal forecast according to user's settings. The forecasts of different models can be viewed, with different SST forcing. They actually are a mean of an ensemble of forecasts by the given model. The user is able to choose the variable which can be temperature at 2m or precipitation. Different analysis of those variables are available: the total field or an anomaly relative to a climatology (see reference below). For precipitation, the relative percentage of a seasonal ensemble model median (see reference below) is also available. The default forecasts available are the latest ones, but the user can navigate through different issue times and their associate lead times. Eventually, the user can apply a skill mask which will allow the display of the forecast where the model is skillfull enough only. The user chooses the minimum correlation between 30 years (from 1971 to 2000) of the mean seasonal ensemble model anomalies and University of East Anglia Climate Research Unit database of monthly anomalies. The locations where this minimum correlation is not reached are masked.</font></td></tr>

<tr><td colspan=6 align=center bgcolor=#DCDCDC><b>Dataset Documentation</b></td></tr>

<tr>
<td>
<b>Model Outputs</b>
<br><font size=-1><b>Data Source</b>:&nbsp;
(<a href="http://iridl.ldeo.columbia.edu/SOURCES/.IRI/.FD/" target="_blank">Forecast Division from IRI</a>)</font>
<INGRID>
7 index
.S dup CopyStream getrealization
    0 get
    cvsunits
    interp dup 2003 ge {
      pop pop pop pop pop
(<br><font size=-1><b>Base Period</b>: Jan 1971 to Dec 2000</font><p>
<b>Observations</b>
<br><font size=-1><b>Data Source</b>:&nbsp;
to be defined
<br><font size=-1><b>Base Period</b>: Jan 1971 to Dec 2000</font>)print
    }{
      dup 2002 ge {pop pop pop pop pop true}{2001 ge {6.5 ge {pop pop pop true}{pop pop pop false}ifelse}{pop pop pop pop false}ifelse}ifelse {
(<br><font size=-1><b>Base Period</b>: Jan 1969 to Dec 1998</font><p>
<b>Observations</b>
<br><font size=-1><b>Data Source</b>:&nbsp;
to be defined
<br><font size=-1><b>Base Period</b>: Jan 1969 to Dec 1998</font>)print
      }{
(<br><font size=-1><b>Base Period</b>: Jan 1961 to Dec 1990</font><p>
<b>Observations</b>
<br><font size=-1><b>Data Source</b>:&nbsp;
to be defined
<br><font size=-1><b>Base Period</b>: Jan 1961 to Dec 1990</font>)print
      }ifelse
    }ifelse
</INGRID>
<p>
<b>Skill Mask</b><br>
<font size=-1><b>Data</b>:&nbsp;
Mask illustrating areas where the skill of the model is not sufficient. The skill is defined as the correlation of the model outputs with the UEA observations database over 30 years, from 1971 to 2000. The correlations are computed over the ensemble mean of the model anomalies relative to the same time line and are seasonal wise.</font>
</td>
</tr>
</table>
<table BORDER COLS=1 width=650 bgcolor="#F5F5F5">
<tr>
<td colspan=2 width=50% align=center bgcolor=#DCDCDC><b>Download Map</b></td>
<td align=center bgcolor=#DCDCDC><b>Download Data</b></td></tr>
<tr>
<INGRID>
showmenu? {
  imagelinkstart 
  (<td align=center>)print
  (Figure as PDF) (.pdf) linktoimageformat
  (</td><td align=center>) print
  (Figure as JPEG) (.jpg) linktoimageformat
   (</td>) print
} if

(<td rowspan=2 align=center><a href=http://iridl.ldeo.columbia.edu/expert/)print
pop 3 index dup dataseturl print 
</INGRID>?help+datafiles#GIS">Data for GIS</a><font color=green>(restricted)</font></td>
</tr>

<tr>
<INGRID>
showmenu? { 
  .auxfig
imagelinkstart
(<td align=center>)print
(Colorscale as PDF) (.pdf) linktoimageformat
(</td><td align=center>) print
(Colorscale as JPEG) (.jpg) linktoimageformat
(</td>) print
pop
} if pop
</INGRID>
</tr>
</table>
</table>
</table>
</center>

</FORM>
</body></html>


